# Redis Production Configuration
# Based on Redis 8.2.0 for prompt-improver application
# Optimized for development with production-ready settings

################################## NETWORK #####################################

# Bind to localhost only for security (development setup)
bind 127.0.0.1 ::1

# Default port
port 6379

# Connection timeout in seconds (0 = no timeout)
timeout 300

# TCP listen() backlog
tcp-backlog 511

# TCP keepalive
tcp-keepalive 300

################################# GENERAL #####################################

# Run as daemon
daemonize yes

# Process supervision
supervised auto

# PID file location  
pidfile /opt/homebrew/var/run/redis.pid

# Log level: debug, verbose, notice, warning, nothing
loglevel notice

# Log file location (empty string = stdout)
logfile /opt/homebrew/var/log/redis/redis-server.log

# Number of databases
databases 16

# Disable ASCII art logo
always-show-logo no

################################ SNAPSHOTTING ################################

# RDB Persistence: Save snapshots to disk
# Format: save <seconds> <changes>
# Save if at least 1 key changed in 900 seconds (15 minutes)
save 900 1
# Save if at least 10 keys changed in 300 seconds (5 minutes)  
save 300 10
# Save if at least 10000 keys changed in 60 seconds (1 minute)
save 60 10000

# Stop accepting writes if RDB snapshots fail
stop-writes-on-bgsave-error yes

# Compress RDB files
rdbcompression yes

# Checksum RDB files  
rdbchecksum yes

# RDB filename
dbfilename dump.rdb

# Working directory for RDB and AOF files
dir /opt/homebrew/var/db/redis/

################################# REPLICATION #################################

# Replication settings optimized for single instance
replica-serve-stale-data yes
replica-read-only yes

################################## SECURITY ###################################

# Disable some commands for security (can be re-enabled if needed)
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG "CONFIG_b8c74e96c02b7e7e"

################################### CLIENTS ####################################

# Max number of connected clients
maxclients 1000

############################## MEMORY MANAGEMENT #############################

# Maximum memory usage (2GB limit for development)
maxmemory 2gb

# Memory eviction policy when max memory is reached
# allkeys-lru: remove any key with LRU algorithm
maxmemory-policy allkeys-lru

# Memory usage sampling for LRU/LFU/TTL algorithms
maxmemory-samples 5

# Memory usage reporting interval (commented - not supported in this version)
# memory-usage-limit-reporting-interval 10

############################# LAZY FREEING ####################################

# Enable lazy freeing for better performance
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

############################ KERNEL OOM CONTROL ##############################

# Better OOM handling
oom-score-adj no

######################### KERNEL TRANSPARENT HUGEPAGE ########################

# Disable transparent huge pages for better latency
disable-thp yes

############################## APPEND ONLY FILE ###############################

# Enable AOF persistence for durability  
appendonly yes

# AOF filename
appendfilename "appendonly.aof"

# AOF fsync policy:
# always: fsync every write (safest, slowest)
# everysec: fsync every second (good balance)  
# no: never fsync, let OS handle it (fastest, least safe)
appendfsync everysec

# Don't fsync during AOF rewrite
no-appendfsync-on-rewrite no

# Automatic AOF rewrite configuration
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Enable mixed RDB-AOF persistence format (Redis 4.0+)
aof-use-rdb-preamble yes

################################ LUA SCRIPTING ###############################

# Lua script timeout in milliseconds
lua-time-limit 5000

################################## SLOW LOG ###################################

# Log queries slower than microseconds (10ms = 10000 microseconds)
slowlog-log-slower-than 10000

# Maximum length of slow log
slowlog-max-len 128

################################ LATENCY MONITOR ##############################

# Enable latency monitoring (0 = disabled)
latency-monitor-threshold 100

################################## GOPHER SERVER ############################

# Disable gopher protocol for security
# gopher-enabled no

############################### ADVANCED CONFIG ############################

# Hash table rehashing
activerehashing yes

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Client query buffer limit
client-query-buffer-limit 1gb

# Protocol buffer limit  
proto-max-bulk-len 512mb

# Frequency of rehashing the main dictionary
hz 10

# Enable dynamic HZ for idle clients
dynamic-hz yes

# AOF rewrite incremental fsync
aof-rewrite-incremental-fsync yes

# RDB save incremental fsync
rdb-save-incremental-fsync yes

# Jemalloc background thread
jemalloc-bg-thread yes

# Hash max ziplist entries/value optimized for performance
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List optimization  
list-max-ziplist-size -2
list-compress-depth 0

# Set optimization
set-max-intset-entries 512

# Sorted set optimization
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog optimization
hll-sparse-max-bytes 3000

# Stream optimization  
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active defragmentation (disabled - requires modified Jemalloc)
# activedefrag yes
# active-defrag-ignore-bytes 100mb
# active-defrag-threshold-lower 10
# active-defrag-threshold-upper 100
# active-defrag-cycle-min 1  
# active-defrag-cycle-max 25
# active-defrag-max-scan-fields 1000

# Client tracking
tracking-table-max-keys 1000000

################################## INCLUDES ###################################

# Include additional configuration files if needed
# include /path/to/local.conf